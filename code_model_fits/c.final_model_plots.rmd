---
title: "c.final_model_visualization"
author: "Dennis Kim"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries}
# call libraries 
library(here)
library(MASS)
library(nlme)
library(mgcv)
library(dplyr)
library(tidyr)
#library(GGally)
library(ggplot2)
library(patchwork)
```

# 0. Data call
load the model fit data
```{r model fit}
# load data 
final_df <- readRDS(here::here("data/0.final_data", "Final_dryland_data.rds"))
model2 <- readRDS(here::here("data/0.final_data", "vulture_model.rds"))

# factorize the cateogrical columns (animal_id, REALM, BIOME_NAME) 
final_df$REALM <- as.factor(final_df$REALM)
final_df$animal_id <- as.factor(final_df$animal_id)

glimpse(final_df)
summary(final_df)
```

# 1. Model assumption checking 
```{r model check}
# remove species that has small samples (4 species removed - now 13 species)
final_df1 <- final_df %>% dplyr::filter(! species %in% c("Cathartes burrovianus", "Gyps bengalensis", "Gyps rueppellii", "Sarcoramphus papa"))

# Remove NA rows and drop unused factor levels
final_df1 <- final_df1 %>%
  filter(!is.na(REALM) & REALM != "N/A") %>%
  drop_na() %>%
  droplevels()

summary(final_df1)
```

# 3.visualization

## 3.1 create prediction grid    
```{r prediction grid}
# 1. Create Prediction Grids
# =====================

# Unique species and REALMs
species_list <- unique(final_df1$species)
realm_list <- unique(final_df1$REALM)

# Sequences for NDVI and Livestock
ndvi_seq <- seq(min(final_df1$dsl_wmNDVI), max(final_df1$dsl_wmNDVI), length.out = 100)
lifestock_seq <- seq(min(final_df1$wmLifestock), max(final_df1$wmLifestock), length.out = 100)

# Species–REALM-specific median coordinates
species_coords <- final_df1 %>%
  group_by(species, REALM) %>%
  summarize(
    lon_med = median(UDwMeanLongitude),
    lat_med = median(UDwMeanLatitude),
    .groups = "drop"
  )

# Choose a known animal_id (just one to avoid NA)
ref_animal <- levels(final_df1$animal_id)[1]

# Build NDVI grid
pred_ndvi_grid <- expand.grid(
  dsl_wmNDVI = ndvi_seq,
  wmLifestock = median(final_df1$wmLifestock),
  species = species_list,
  REALM = realm_list
) %>%
  left_join(species_coords, by = c("species", "REALM")) %>%
  mutate(
    UDwMeanLongitude = lon_med,
    UDwMeanLatitude = lat_med,
    animal_id = ref_animal
  ) %>%
  filter(!is.na(UDwMeanLongitude)) %>%
  select(-lon_med, -lat_med)

# Build Livestock grid
pred_LS_grid <- expand.grid(
  wmLifestock = lifestock_seq,
  dsl_wmNDVI = median(final_df1$dsl_wmNDVI),
  species = species_list,
  REALM = realm_list
) %>%
  left_join(species_coords, by = c("species", "REALM")) %>%
  mutate(
    UDwMeanLongitude = lon_med,
    UDwMeanLatitude = lat_med,
    animal_id = ref_animal
  ) %>%
  filter(!is.na(UDwMeanLongitude)) %>%
  select(-lon_med, -lat_med)

# Match factor levels
pred_ndvi_grid$species <- factor(pred_ndvi_grid$species, levels = levels(final_df1$species))
pred_ndvi_grid$REALM <- factor(pred_ndvi_grid$REALM, levels = levels(final_df1$REALM))
pred_ndvi_grid$animal_id <- factor(pred_ndvi_grid$animal_id, levels = levels(final_df1$animal_id))

pred_LS_grid$species <- factor(pred_LS_grid$species, levels = levels(final_df1$species))
pred_LS_grid$REALM <- factor(pred_LS_grid$REALM, levels = levels(final_df1$REALM))
pred_LS_grid$animal_id <- factor(pred_LS_grid$animal_id, levels = levels(final_df1$animal_id))
```

## 3.2 get predictions from the model 
```{r pred values}
# Predict NDVI
predictions_ndvi <- predict(model2, newdata = pred_ndvi_grid, se.fit = TRUE)
pred_ndvi_grid$fit <- predictions_ndvi$fit
pred_ndvi_grid$se <- predictions_ndvi$se.fit

# Predict Livestock
predictions_LS <- predict(model2, newdata = pred_LS_grid, se.fit = TRUE)
pred_LS_grid$fit <- predictions_LS$fit
pred_LS_grid$se <- predictions_LS$se.fit

# Add 95% confidence intervals
pred_ndvi_grid <- pred_ndvi_grid %>%
  group_by(species, REALM) %>% 
  mutate(
    lower = fit - 1.96 * se,
    upper = fit + 1.96 * se
  ) %>% 
  ungroup()

pred_LS_grid <- pred_LS_grid %>%
  group_by(species, REALM) %>% 
  mutate(
    lower = fit - 1.96 * se,
    upper = fit + 1.96 * se
  ) %>% 
  ungroup()

# Optional: Check results
summary(pred_ndvi_grid$fit)
summary(pred_LS_grid$fit)
summary(pred_LS_grid$lower)

# save the model 2
#saveRDS(pred_ndvi_grid, file = "final_predictions_dsl_NDVI.rds")
#saveRDS(pred_LS_grid, file = "final_predictions_Lifestock.rds")
```

## 3.3 visualization
```{r}
# color-paelette
glasbey_13 <- c(
  "#E6194B", "#3CB44B", "#FFE119", "#4363D8", "#F58231",
  "#911EB4", "#46F0F0", "#F032E6", "#BCF60C", "#FABEBE",
  "#008080", "#E6BEFF", "#9A6324"
)

# Apply loess smoothing per species
smoothed_ndvi_ribbons <- pred_ndvi_grid %>%
  group_by(species) %>%
  arrange(dsl_wmNDVI) %>%
  mutate(
    fit_smooth   = predict(loess(fit ~ dsl_wmNDVI, span = 0.5)),
    lower_smooth = predict(loess(lower ~ dsl_wmNDVI, span = 0.5)),
    upper_smooth = predict(loess(upper ~ dsl_wmNDVI, span = 0.5))
  ) %>%
  ungroup()

smoothed_LS_ribbons <- pred_LS_grid %>%
  group_by(species) %>%
  arrange(wmLifestock) %>%
  mutate(
    fit_smooth   = predict(loess(fit ~ wmLifestock, span = 0.5)),
    lower_smooth = predict(loess(lower ~ wmLifestock, span = 0.5)),
    upper_smooth = predict(loess(upper ~ wmLifestock, span = 0.5))
  ) %>%
  ungroup()
```


```{r ndvi}
# NDVI

# species levels
fig1a <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_ndvi_ribbons, 
              aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = species),
              alpha = 0.2, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_ndvi_grid, 
            aes(x = dsl_wmNDVI, y = fit, color = species), 
            method = "loess", se = FALSE, size = 1)+
  
  # Color scheme
  scale_color_manual(values = glasbey_13) +
  scale_fill_manual(values = glasbey_13) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "",
    y = expression("Change in UD Size (km²)"),
    color = "Species",
    fill = "Species"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~species)

fig1b <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_ndvi_ribbons, 
              aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = species),
              alpha = 0.1, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_ndvi_grid, 
            aes(x = dsl_wmNDVI, y = fit, color = species), 
            method = "loess", se = FALSE, size = 1)+
  
  # Vertical line at x = 0
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  
  # Color scheme
  scale_color_manual(values = glasbey_13) +
  scale_fill_manual(values = glasbey_13) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "Change in NDVI (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Species",
    fill = "Species"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~species, scales = "free_y")

fig1a
fig1b
```

```{r figure combine}
library(patchwork)

figure_ndvi <- (fig1a / fig1b)+ plot_layout(guides = "collect", axis_titles = "collect")

figure_ndvi
```

```{r LS}
# LS
fig2a <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_LS_ribbons, 
              aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = species),
              alpha = 0.2, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_LS_grid, 
            aes(x = wmLifestock, y = fit, color = species), 
            method = "loess", se = FALSE, size = 1)+
  
  # Color scheme
  scale_color_manual(values = glasbey_13) +
  scale_fill_manual(values = glasbey_13) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "",
    y = expression("Change in UD Size (km²)"),
    color = "Species",
    fill = "Species"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~species)

fig2b <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_LS_ribbons, 
              aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = species),
              alpha = 0.2, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_LS_grid, 
            aes(x = wmLifestock, y = fit, color = species), 
            method = "loess", se = FALSE, size = 1)+
  
  # Color scheme
  scale_color_manual(values = glasbey_13) +
  scale_fill_manual(values = glasbey_13) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "Lifestock (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Species",
    fill = "Species"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~species, scales = "free_y")

fig2a
fig2b
```

```{r figure combine}
figure_lifestock <- (fig2a/ fig2b)+ plot_layout(guides = "collect", axis_titles = "collect")

figure_lifestock
```

```{r figure zoom In combine}
figure_together <- (fig1b/ fig2b)+ plot_layout(guides = "collect", axis_titles = "collect")
figure_together
```


# REALM grouping visualization
```{r REALM}
# Apply loess smoothing per species
smoothed_ndvi_realm_ribbons <- pred_ndvi_grid %>%
  group_by(REALM) %>%
  arrange(dsl_wmNDVI) %>%
  mutate(
    fit_smooth   = predict(loess(fit ~ dsl_wmNDVI, span = 0.5)),
    lower_smooth = predict(loess(lower ~ dsl_wmNDVI, span = 0.5)),
    upper_smooth = predict(loess(upper ~ dsl_wmNDVI, span = 0.5))
  ) %>%
  ungroup()

smoothed_LS_realm_ribbons <- pred_LS_grid %>%
  group_by(REALM) %>%
  arrange(wmLifestock) %>%
  mutate(
    fit_smooth   = predict(loess(fit ~ wmLifestock, span = 0.5)),
    lower_smooth = predict(loess(lower ~ wmLifestock, span = 0.5)),
    upper_smooth = predict(loess(upper ~ wmLifestock, span = 0.5))
  ) %>%
  ungroup()

# Okabe-Ito palette (first 5 colors)
okabe_ito <- c(
  "#B85C00", # dark orange (unchanged)
  "#00714A", # dark bluish green (kept, very distinct)
  "#7A4900", # warm dark brown (replaces gold/yellow)
  "#781C81", # dark purple (strong contrast with others)
  "#1B4F72"  # deep steel blue (unique, darker and not similar to sky blue)
)
```

```{r REALM ndvi}
# NDVI
fig3a <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_ndvi_realm_ribbons, 
              aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
              alpha = 0.1, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_ndvi_grid, 
            aes(x = dsl_wmNDVI, y = fit, color = REALM), 
            method = "loess", se = FALSE, size = 1)+
  
   # Vertical line at x = 0
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  
  # Color scheme
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "Change in NDVI (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~REALM, scales = "free_y")

fig3a
```

```{r realm lifestock}
# Lifestock
fig3b <- ggplot() +
  # 95% Confidence Intervals
   geom_ribbon(data = smoothed_LS_realm_ribbons, 
              aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
              alpha = 0.2, color = NA)+
  
  # Fitted lines
  geom_smooth(data = pred_LS_grid, 
            aes(x = wmLifestock, y = fit, color = REALM), 
            method = "loess", se = FALSE, size = 1)+

  
  # Color scheme
  scale_color_manual(values = glasbey_13) +
  scale_fill_manual(values = glasbey_13) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "Lifestock (weighted mean)",
    y = "",
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per species
  facet_wrap(~REALM, scales = "free")

fig3b
```

```{r realm figures}
figure_realm <- (fig3a | fig3b)+ plot_layout(guides = "collect", axis_titles = "collect")

figure_realm

ggsave(
  filename = "figure_realm.png",
  plot = figure_realm,
  width = 11,       # in inches (adjust as needed)
  height = 4,      # in inches
  dpi = 600
)
```

```{r}
library(gratia)
appraise(model2)
```


