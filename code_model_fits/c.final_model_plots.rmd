---
title: "c.final_model_visualization"
author: "Dennis Kim"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries}
# call libraries 
library(here)
library(MASS)
library(nlme)
library(mgcv)
library(dplyr)
library(tidyr)
#library(GGally)
library(ggplot2)
library(patchwork)
```

# 0. Data call
load the model fit data
```{r model fit}
# load data 
final_df <- readRDS(here::here("data/0.final_data", "Final_dryland_data.rds"))
model2 <- readRDS(here::here("data/0.final_data", "vulture_model.rds"))

# factorize the cateogrical columns (animal_id, REALM, BIOME_NAME) 
final_df$REALM <- as.factor(final_df$REALM)
final_df$animal_id <- as.factor(final_df$animal_id)

glimpse(final_df$dsl_wmNDVI)
summary(final_df$dsl_wmNDVI)
summary(final_df$dsl_UD)

unique(final_df$REALM)
```

# 1. Model assumption checking 
```{r model check}
# remove species that has small samples (4 species removed - now 13 species)
final_df1 <- final_df %>% dplyr::filter(! species %in% c("Cathartes burrovianus", "Gyps bengalensis", "Gyps rueppellii", "Sarcoramphus papa"))

# Remove NA rows and drop unused factor levels
final_df1 <- final_df1 %>%
  filter(!is.na(REALM) & REALM != "N/A") %>%
  drop_na() %>%
  droplevels()

summary(final_df1)
```

# 3.visualization

## 3.1 create prediction grid    
```{r prediction grid}
# 1. Create Prediction Grids

## Unique species and REALMs
valid_pairs <- final_df1 %>% distinct(species, REALM)

## Sequences for NDVI and Livestock
ndvi_seq <- seq(min(final_df1$dsl_wmNDVI), max(final_df1$dsl_wmNDVI), length.out = 100)
lifestock_seq <- seq(min(final_df1$wmLifestock), max(final_df1$wmLifestock), length.out = 100)

## Species–REALM-specific median coordinates
species_coords <- final_df1 %>%
  group_by(species, REALM) %>%
  summarize(
    lon_med = median(UDwMeanLongitude),
    lat_med = median(UDwMeanLatitude),
    .groups = "drop"
  )

## Choose a known animal_id (just one to avoid NA)
ref_animal <- levels(final_df1$animal_id)[1]

# 2. Build NDVI grid
pred_ndvi_grid <- valid_pairs %>%
  left_join(species_coords, by = c("species", "REALM")) %>%
  tidyr::crossing(dsl_wmNDVI = ndvi_seq) %>%
  mutate(
    wmLifestock = median(final_df1$wmLifestock),
    UDwMeanLongitude = lon_med,
    UDwMeanLatitude  = lat_med,
    animal_id = ref_animal
  ) %>%
  select(-lon_med, -lat_med)

# 3. Build Livestock grid
pred_LS_grid <- valid_pairs %>%
  left_join(species_coords, by = c("species", "REALM")) %>%
  tidyr::crossing(wmLifestock = lifestock_seq) %>%
  mutate(
    dsl_wmNDVI = median(final_df1$dsl_wmNDVI),
    UDwMeanLongitude = lon_med,
    UDwMeanLatitude  = lat_med,
    animal_id = ref_animal
  ) %>%
  select(-lon_med, -lat_med)

# Match factor levels
pred_ndvi_grid$species <- factor(pred_ndvi_grid$species, levels = levels(final_df1$species))
pred_ndvi_grid$REALM <- factor(pred_ndvi_grid$REALM, levels = levels(final_df1$REALM))
pred_ndvi_grid$animal_id <- factor(pred_ndvi_grid$animal_id, levels = levels(final_df1$animal_id))

pred_LS_grid$species <- factor(pred_LS_grid$species, levels = levels(final_df1$species))
pred_LS_grid$REALM <- factor(pred_LS_grid$REALM, levels = levels(final_df1$REALM))
pred_LS_grid$animal_id <- factor(pred_LS_grid$animal_id, levels = levels(final_df1$animal_id))
```

## 3.2 get predictions from the model 
```{r pred values}
# Predict NDVI
predictions_ndvi <- predict(model2, newdata = pred_ndvi_grid, se.fit = TRUE, re.form = NA)
pred_ndvi_grid$fit <- predictions_ndvi$fit
pred_ndvi_grid$se  <- predictions_ndvi$se.fit

# Predict Livestock
predictions_LS <- predict(model2, newdata = pred_LS_grid, se.fit = TRUE, re.form = NA)
pred_LS_grid$fit <- predictions_LS$fit
pred_LS_grid$se  <- predictions_LS$se.fit

# Add 95% confidence intervals
pred_ndvi_grid <- pred_ndvi_grid %>%
  mutate(
    lower = fit - 1.96 * se,
    upper = fit + 1.96 * se
  )

pred_LS_grid <- pred_LS_grid %>%
  mutate(
    lower = fit - 1.96 * se,
    upper = fit + 1.96 * se
  )

# FIXED — use model output directly (NO LOESS)
smoothed_ndvi_ribbons <- pred_ndvi_grid %>%
  rename(
    fit_smooth   = fit,
    lower_smooth = lower,
    upper_smooth = upper
  )

smoothed_LS_ribbons <- pred_LS_grid %>%
  rename(
    fit_smooth   = fit,
    lower_smooth = lower,
    upper_smooth = upper
  )

# save the model 2
saveRDS(pred_ndvi_grid, file = "final_predictions_dsl_NDVI.rds")
saveRDS(pred_LS_grid, file = "final_predictions_Lifestock.rds")
```

## 3.3 visualization

plot species level of relative changes in the NDVI
```{r ndvi}
# Okabe-Ito palette (first 5 colors)
okabe_ito <- c(
  "#B85C00", # dark orange (unchanged)
  "#00714A", # dark bluish green (kept, very distinct)
  "#7A4900", # warm dark brown (replaces gold/yellow)
  "#781C81", # dark purple (strong contrast with others)
  "#1B4F72"  # deep steel blue (unique, darker and not similar to sky blue)
)

# NDVI
fig1 <-ggplot() +
  geom_ribbon(
    data = smoothed_ndvi_ribbons,
    aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.1, color = NA
  ) +
  
  geom_line(
    data = smoothed_ndvi_ribbons,
    aes(x = dsl_wmNDVI, y = fit_smooth, color = REALM),
    size = 1
  ) +

  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +

  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +

 # Theme and labels
  theme_minimal() +
  labs(
    x = "Change in NDVI (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 8)
  ) +
  
   # Facet by REALM (rows) and species (columns), but hide REALM labels
  facet_wrap(REALM ~ species, labeller = labeller(REALM = function(x) ""))

ggsave(
  filename = "figure_realm_NDVI_species_level.png",
  plot = fig1,
  width = 11,       # in inches (adjust as needed)
  height = 5,      # in inches
  dpi = 600
)
```

```{r LS}
fig2 <- ggplot() +
  # 95% Confidence Intervals
  geom_ribbon(
    data = smoothed_LS_ribbons, 
    aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.2, color = NA
  ) +
  
  # Fitted lines — FIXED: use model predictions
  geom_line(
    data = smoothed_LS_ribbons,
    aes(x = wmLifestock, y = fit_smooth, color = REALM),
    size = 1
  ) +
  
  # Color scheme
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    x = "Lifestock (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 8)
  ) +
  
   # Facet by REALM (rows) and species (columns), but hide REALM labels
  facet_wrap(REALM ~ species, labeller = labeller(REALM = function(x) ""))

ggsave(
  filename = "figure_realm_Lifestock_species_level.png",
  plot = fig2,
  width = 11,       # in inches (adjust as needed)
  height = 5,      # in inches
  dpi = 600
)
```

# REALM grouping visualization
```{r REALM}
# Apply loess smoothing per species
smoothed_ndvi_realm_summary <- smoothed_ndvi_realm_ribbons %>%
  group_by(REALM, dsl_wmNDVI) %>%
  summarise(
    fit_smooth   = mean(fit_smooth),
    lower_smooth = mean(lower_smooth),
    upper_smooth = mean(upper_smooth),
    .groups = "drop"
  )

smoothed_LS_realm_ribbons <- pred_LS_grid %>%
  # Create the *_smooth columns from model predictions
  mutate(
    fit_smooth   = fit,
    lower_smooth = lower,
    upper_smooth = upper
  ) %>%
  group_by(REALM, wmLifestock) %>%
  summarise(
    fit_smooth   = mean(fit_smooth),
    lower_smooth = mean(lower_smooth),
    upper_smooth = mean(upper_smooth),
    .groups = "drop"
  )
```

```{r REALM ndvi}
# NDVI
fig3a <- ggplot() +
  geom_ribbon(
    data = smoothed_ndvi_realm_summary,
    aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.1, color = NA
  ) +
  geom_line(
    data = smoothed_ndvi_realm_summary,
    aes(x = dsl_wmNDVI, y = fit_smooth, color = REALM),
    size = 1
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  theme_minimal() +
  labs(
    title = "(a)",
    x = "Change in NDVI (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~REALM)

fig3b <- ggplot() +
  geom_ribbon(
    data = smoothed_ndvi_realm_summary,
    aes(x = dsl_wmNDVI, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.1, color = NA
  ) +
  geom_line(
    data = smoothed_ndvi_realm_summary,
    aes(x = dsl_wmNDVI, y = fit_smooth, color = REALM),
    size = 1
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  theme_minimal() +
  labs(
    title = "(b)",
    x = "Change in NDVI (weighted mean)",
    y = "",
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~REALM, scale = "free")
```

```{r realm ndvi figures}
figure_realm_NDVI <- (fig3a | fig3b)+ plot_layout(guides = "collect", axis_titles = "collect")

figure_realm_NDVI

ggsave(
  filename = "figure_realm_NDVI.png",
  plot = figure_realm_NDVI,
  width = 11,       # in inches (adjust as needed)
  height = 4,      # in inches
  dpi = 600
)
```

```{r realm lifestock}
# Lifestock
fig4a <- ggplot() +
  # 95% Confidence Intervals
  geom_ribbon(
    data = smoothed_LS_realm_ribbons, 
    aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.2, color = NA
  ) +
  
  # Fitted lines — use model predictions directly
  geom_line(
    data = smoothed_LS_realm_ribbons,
    aes(x = wmLifestock, y = fit_smooth, color = REALM),
    size = 1
  ) +
  
  # Color scheme
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    title = "(a)",
    x = "Lifestock (weighted mean)",
    y = expression("Change in UD Size (km²)"),
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per REALM
  facet_wrap(~REALM)

fig4b <- ggplot() +
  # 95% Confidence Intervals
  geom_ribbon(
    data = smoothed_LS_realm_ribbons, 
    aes(x = wmLifestock, ymin = lower_smooth, ymax = upper_smooth, fill = REALM),
    alpha = 0.2, color = NA
  ) +
  
  # Fitted lines — use model predictions directly
  geom_line(
    data = smoothed_LS_realm_ribbons,
    aes(x = wmLifestock, y = fit_smooth, color = REALM),
    size = 1
  ) +
  
  # Color scheme
  scale_color_manual(values = okabe_ito) +
  scale_fill_manual(values = okabe_ito) +
  
  # Theme and labels
  theme_minimal() +
  labs(
    title = "(b)",
    x = "Lifestock (weighted mean)",
    y = "",
    color = "Realm",
    fill = "Realm"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 8)
  ) +
  
  # One facet per REALM
  facet_wrap(~REALM, scale = "free_y")
```

```{r realm lifestock figures}
figure_realm_LS <- (fig4a | fig4b)+ plot_layout(guides = "collect", axis_titles = "collect")

figure_realm_LS

ggsave(
  filename = "figure_realm_Lifestock.png",
  plot = figure_realm_LS,
  width = 11,       # in inches (adjust as needed)
  height = 4,      # in inches
  dpi = 600
)
```
